{% extends "base.html" %}
{% block title %}Listening History{% endblock %}

{% block content %}
<div class="hero-content">
  <h1 class="hero-title">Listening History</h1>
  <p class="hero-description">A log of my Spotify listening history that I'm storing in an SQLite db (<a href="https://github.com/marcolanfranchi/spotify-history">project</a>).</p>
  <p id="total-plays" class="music-total">Loading...</p>
</div>

<div class="section" id="activity-chart-section">
  <div class="activity-chart-wrapper">
    <div class="activity-months"></div>
    <div class="activity-content">
      <div class="activity-days-labels">
        <span></span>
        <span>Mon</span>
        <span></span>
        <span>Wed</span>
        <span></span>
        <span>Fri</span>
        <span></span>
      </div>
      <div id="activity-chart"></div>
    </div>
  </div>
  <div class="activity-legend-wrapper">
    <div class="activity-legend">
      <span>Less</span>
      <div class="legend-box" style="background-color: #ebedf0;"></div>
      <div class="legend-box" style="background-color: #9be9a8;"></div>
      <div class="legend-box" style="background-color: #40c463;"></div>
      <div class="legend-box" style="background-color: #30a14e;"></div>
      <div class="legend-box" style="background-color: #216e39;"></div>
      <span>More</span>
    </div>
  </div>
</div>

<div class="section" id="music">
  <div id="music-container">
    <p>Loading music listening history...</p>
  </div>
</div>

<script>
const CSV_URL = "https://raw.githubusercontent.com/marcolanfranchi/spotify-history/main/data/plays.csv";

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    const char = line[i];
    if (char === '"') inQuotes = !inQuotes;
    else if (char === ',' && !inQuotes) {
      result.push(current.trim());
      current = '';
    } else current += char;
  }
  result.push(current.trim());
  return result;
}

async function getPlays() {
  const res = await fetch(CSV_URL);
  const text = await res.text();
  const lines = text.trim().split("\n");
  
  return lines.slice(1).map(line => {
    const parts = parseCSVLine(line);
    return {
      played_at: parts[0] || "",
      track_name: parts[2] || "Unknown Track",
      artist_name: parts[3] || "Unknown Artist"
    };
  })
  .filter(play => play.played_at)
  .sort((a, b) => new Date(b.played_at) - new Date(a.played_at));
}

function formatDate(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString("en-US", {
    weekday: "short",
    month: "short",
    day: "numeric",
    year: "numeric"
  });
}

function formatTime(datetime) {
  const date = new Date(datetime);
  return date.toLocaleTimeString("en-US", { 
    hour: "numeric", 
    minute: "2-digit",
    hour12: true 
  });
}

function getLocalDateKey(utcDateStr) {
  const date = new Date(utcDateStr);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function generateDots(count) {
  let dotsHtml = '';
  for (let i = 0; i < count; i++) {
    const randomDelay = Math.random() * 4.5;
    dotsHtml += `<span style="animation-delay: ${randomDelay.toFixed(2)}s">•</span>`;
  }
  return dotsHtml;
}

function renderActivityChart(plays) {
  const chartContainer = document.getElementById("activity-chart");
  const monthsContainer = document.querySelector(".activity-months");
  chartContainer.innerHTML = "";
  monthsContainer.innerHTML = "";

  const playsByDay = plays.reduce((acc, play) => {
    const day = getLocalDateKey(play.played_at);
    acc[day] = (acc[day] || 0) + 1;
    return acc;
  }, {});

  const today = new Date();
  const startDate = new Date(today);
  startDate.setDate(today.getDate() - (30 * 7));

  const weeks = [];
  let currentWeek = [];
  let currentDate = new Date(startDate);

  const monthPositions = [];
  let lastMonth = -1;
  let weekIndex = 0;

  const startDay = currentDate.getDay();
  for (let i = 0; i < startDay; i++) {
    currentWeek.push(null);
  }

  while (currentDate <= today) {
    const dateKey = getLocalDateKey(currentDate.toISOString());
    const count = playsByDay[dateKey] || 0;
    
    const month = currentDate.getMonth();
    if (month !== lastMonth && currentDate.getDay() === 0) {
      monthPositions.push({
        month: currentDate.toLocaleDateString("en-US", { month: "short" }),
        position: weekIndex
      });
      lastMonth = month;
    }

    currentWeek.push({
      date: new Date(currentDate),
      dateKey: dateKey,
      count: count
    });

    if (currentWeek.length === 7) {
      weeks.push(currentWeek);
      currentWeek = [];
      weekIndex++;
    }

    currentDate.setDate(currentDate.getDate() + 1);
  }

  if (currentWeek.length > 0) {
    while (currentWeek.length < 7) {
      currentWeek.push(null);
    }
    weeks.push(currentWeek);
  }

  const cellWidth = 8;
  const gap = 2;
  const weekWidth = cellWidth + gap;

  monthPositions.forEach(({ month, position }) => {
    const label = document.createElement("span");
    label.className = "month-label";
    label.textContent = month;
    label.style.left = `${position * weekWidth}px`;
    monthsContainer.appendChild(label);
  });

  const maxCount = Math.max(...Object.values(playsByDay), 1);
  const getColor = (count) => {
    if (count === 0) return "#ebedf0";
    const intensity = count / maxCount;
    if (intensity < 0.25) return "#9be9a8";
    if (intensity < 0.5) return "#40c463";
    if (intensity < 0.75) return "#30a14e";
    return "#216e39";
  };

  const chart = document.createElement("div");
  chart.className = "activity-grid";

  const tooltip = document.createElement("div");
  tooltip.className = "activity-tooltip";
  document.body.appendChild(tooltip);

  weeks.forEach(week => {
    const weekCol = document.createElement("div");
    weekCol.className = "activity-week";
    
    week.forEach(day => {
      const dayCell = document.createElement("div");
      dayCell.className = "activity-day";
      
      if (day) {
        dayCell.style.backgroundColor = getColor(day.count);
        dayCell.dataset.date = day.date.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
        dayCell.dataset.count = day.count;

        dayCell.addEventListener("mouseenter", (e) => {
          tooltip.textContent = `${day.count} plays on ${dayCell.dataset.date}`;
          tooltip.style.display = "block";
          tooltip.style.left = `${e.pageX}px`;
          tooltip.style.top = `${e.pageY - 40}px`;
        });

        dayCell.addEventListener("mousemove", (e) => {
          tooltip.style.left = `${e.pageX}px`;
          tooltip.style.top = `${e.pageY - 40}px`;
        });

        dayCell.addEventListener("mouseleave", () => {
          tooltip.style.display = "none";
        });
      } else {
        dayCell.style.backgroundColor = "transparent";
      }
      
      weekCol.appendChild(dayCell);
    });
    
    chart.appendChild(weekCol);
  });

  chartContainer.appendChild(chart);
}

async function renderMusic() {
  const container = document.getElementById("music-container");
  container.innerHTML = "";

  try {
    const plays = await getPlays();

    if (plays.length === 0) {
      container.innerHTML = '<p>No music listening history found.</p>';
      return;
    }

    document.getElementById("total-plays").textContent = `(${plays.length.toLocaleString()} plays logged in total)`;

    renderActivityChart(plays);

    const byDay = plays.reduce((acc, play) => {
      const day = getLocalDateKey(play.played_at);
      acc[day] = acc[day] || [];
      acc[day].push(play);
      return acc;
    }, {});

    const days = Object.keys(byDay).sort((a, b) => new Date(b) - new Date(a));

    let lastMonth = null;

    days.forEach((day, index) => {
      const items = byDay[day];
      const dateObj = new Date(items[0].played_at);

      const monthLabel = dateObj.toLocaleDateString("en-US", {
        month: "long",
        year: "numeric"
      });

      if (monthLabel !== lastMonth) {
        lastMonth = monthLabel;

        const monthSeparator = document.createElement("div");
        monthSeparator.className = "music-month-separator";
        monthSeparator.textContent = monthLabel;
        container.appendChild(monthSeparator);
      }

      const isFirstDay = index === 0;

      const daySection = document.createElement("div");
      daySection.className = "music-day";

      const header = document.createElement("h3");
      header.className = "music-day-header";
      header.style.cursor = "pointer";
      header.innerHTML = `
        <span class="collapse-arrow">${isFirstDay ? '▼' : '▶'}</span>
        ${formatDate(items[0].played_at)}
        <span class="dot-bar">${generateDots(items.length)}</span>
        <span class="play-count">(${items.length})</span>
      `;

      // Count plays per artist for this day
      const artistCounts = items.reduce((acc, play) => {
        acc[play.artist_name] = (acc[play.artist_name] || 0) + 1;
        return acc;
      }, {});

      // Sort artists by play count
      const sortedArtists = Object.entries(artistCounts)
        .sort((a, b) => b[1] - a[1]);

      const artistList = document.createElement("div");
      artistList.className = "music-artists";
      artistList.style.display = isFirstDay ? "block" : "none";

      sortedArtists.forEach(([artist, count]) => {
        const artistItem = document.createElement("div");
        artistItem.className = "music-artist";
        artistItem.innerHTML = `
          <span class="artist-name">${artist}</span>
          <span class="artist-count">${count} play${count > 1 ? 's' : ''}</span>
        `;
        artistList.appendChild(artistItem);
      });

      header.addEventListener("click", () => {
        const isOpen = artistList.style.display === "block";
        artistList.style.display = isOpen ? "none" : "block";
        header.querySelector(".collapse-arrow").textContent = isOpen ? "▶" : "▼";
      });

      daySection.appendChild(header);
      daySection.appendChild(artistList);
      container.appendChild(daySection);
    });

  } catch (error) {
    console.error("Error loading music listening history:", error);
    container.innerHTML = '<p>Error loading music listening history.</p>';
  }
}

renderMusic();
</script>

<style>
#activity-chart-section {
  margin-bottom: 2rem;
}

.activity-chart-wrapper {
  overflow-x: auto;
  padding-bottom: 0.5rem;
}

.activity-months {
  display: flex;
  position: relative;
  height: 20px;
  margin-bottom: 4px;
  margin-left: 30px;
}

.month-label {
  position: absolute;
  font-size: 0.7rem;
  color: #666;
}

.activity-content {
  display: flex;
  gap: 6px;
}

.activity-days-labels {
  display: flex;
  flex-direction: column;
  gap: 2px;
  padding-top: 0px;
}

.activity-days-labels span {
  height: 8px;
  font-size: 0.6rem;
  color: #666;
  line-height: 8px;
  text-align: right;
  padding-right: 3px;
  width: 24px;
}

.activity-grid {
  display: flex;
  gap: 2px;
  width: fit-content;
}

.activity-week {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.activity-day {
  width: 8px;
  height: 8px;
  border-radius: 2px;
  cursor: pointer;
  transition: transform 0.1s;
}

.activity-day:hover {
  transform: scale(1.3);
}

.activity-tooltip {
  position: absolute;
  display: none;
  background-color: rgba(0, 0, 0, 0.85);
  color: white;
  padding: 6px 10px;
  border-radius: 4px;
  font-size: 0.75rem;
  pointer-events: none;
  white-space: nowrap;
  z-index: 1000;
  transform: translateX(-50%);
}

.activity-legend-wrapper {
  margin-left: 30px;
}

.activity-legend {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 3px;
  margin-top: 0.75rem;
  font-size: 0.65rem;
  color: #666;
}

.legend-box {
  width: 8px;
  height: 8px;
  border-radius: 2px;
}

.music-total {
  margin-top: 0.3rem;
  font-size: 0.85rem;
  color: #444;
}

.music-month-separator {
  margin-top: 2rem;
  margin-bottom: 0.75rem;
  font-size: 1rem;
  font-weight: 500;
  color: #111111;
  border-left: 1px solid #ccc;
  padding-left: 0.5rem;
}

.dot-bar {
  margin-left: 8px;
  color: #000;
  font-size: 1.05rem;
}

.dot-bar span {
  display: inline-block;
  animation: dotGlitch 4.5s infinite;
  color: #101010;
  opacity: 0.9;
}

@keyframes dotGlitch {
  0% { opacity: 0.9; }
  2% { opacity: 0.6; }
  3% { opacity: 0.3; }
  3.5% { opacity: 0.5; }
  4% { opacity: 0.2; }
  4.5% { opacity: 0.6; }
  5.5% { opacity: 0.4; }
  6% { opacity: 0.7; }
  7% { opacity: 0.9; }
  100% { opacity: 0.9; }
}

.music-day {
  margin-bottom: 1rem;
}

.music-day-header {
  margin: 0.4rem 0;
  font-size: 0.9rem;
  color: #222;
  font-weight: 500;
}

.collapse-arrow {
  display: inline-block;
  width: 1em;
  font-size: 0.7rem;
  color: #666;
}

.play-count {
  color: #888;
  font-size: 0.85em;
  font-weight: 400;
  margin-left: 0.2rem;
}

.music-artists {
  margin-top: 0.4rem;
  display: flex;
  flex-direction: column;
  gap: 0.3rem;
}

.music-artist {
  font-size: 0.8rem;
  color: #555;
  line-height: 1;
  display: flex;
  align-items: center;
  padding: 0.25rem 0;
  border-bottom: 1px solid #f0f0f0;
  gap: 0.5rem;
}

.artist-name {
  font-weight: 500;
  color: #333;
}

.artist-count {
  color: #999;
  font-size: 0.75rem;
}

@media (max-width: 768px) {
  .music-artist {
    font-size: 0.75rem;
  }
  .artist-count {
    font-size: 0.7rem;
  }
}
</style>
{% endblock %}