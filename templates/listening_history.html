{% extends "base.html" %}
{% block title %}Listening History{% endblock %}

{% block content %}
<div class="hero-content">
  <h1 class="hero-title">Listening History</h1>
  <p class="hero-description">
    A log of my Spotify listening history that I'm storing in an SQLite db
    (<a href="https://github.com/marcolanfranchi/spotify-history">project</a>).
  </p>
  <p id="total-plays" class="music-total">Loading...</p>
</div>

<!-- ================= MAIN LAYOUT ================= -->
<div class="listening-layout">

  <!-- LEFT COLUMN (65%) -->
  <div class="listening-left-column">
    
    <!-- TOP ROW: QUICK STATS -->
    <div class="section">
      <h2 class="section-title">Quick Stats</h2>
      <div class="stats-grid stats-grid-left">
        <div class="stat">
          <div class="stat-label">Started tracking:</div>
          <div class="stat-value" id="first-day">–</div>
        </div>
        <div class="stat">
          <div class="stat-label">Total plays logged:</div>
          <div class="stat-value" id="total-plays-stat">–</div>
        </div>
        <div class="stat">
          <div class="stat-label">Average daily plays:</div>
          <div class="stat-value" id="avg-daily">–</div>
        </div>
      </div>
    </div>

    <!-- FULL LISTENING LOG -->
    <div class="section listening-main">
      <h2 class="section-title">Full Listening Log</h2>
      <div id="music-container">
        <p>Loading music listening history...</p>
      </div>
    </div>

  </div>

  <!-- RIGHT COLUMN (35%) -->
  <aside class="listening-sidebar">

    <!-- ACTIVITY -->
    <div class="section section-activity">
       <h2 class="section-title">Activity</h2>
        <p class="section-subtitle">Last ~30 weeks</p>

        <div class="activity-chart-wrapper">
          <div class="activity-months"></div>
          <div class="activity-content">
            <div class="activity-days-labels">
              <span></span>
              <span>Mon</span>
              <span></span>
              <span>Wed</span>
              <span></span>
              <span>Fri</span>
              <span></span>
            </div>
            <div id="activity-chart"></div>
          </div>
        </div>

        <div class="activity-legend-wrapper">
          <div class="activity-legend">
            <span>Less plays</span>
            <div class="legend-box" style="background-color:#ebedf0"></div>
            <div class="legend-box" style="background-color:#9be9a8"></div>
            <div class="legend-box" style="background-color:#40c463"></div>
            <div class="legend-box" style="background-color:#30a14e"></div>
            <div class="legend-box" style="background-color:#216e39"></div>
            <span>More plays</span>
          </div>
        </div>
    </div>

    <!-- THIS WEEK -->
    <div class="section section-weekly">
      <h2 class="section-title">This Week</h2>

      <div class="weekly-stats">
        <div class="stats-grid stats-grid-left">
          <div class="stat">
            <div class="stat-label">Hours listened:</div>
            <div class="stat-value" id="week-hours">–</div>
          </div>

          <div class="stat">
            <div class="stat-label">Unique tracks:</div>
            <div class="stat-value" id="week-unique-tracks">–</div>
          </div>

          <div class="stat">
            <div class="stat-label">Top artist:</div>
            <div class="stat-value" id="week-top-artist">–</div>
          </div>

        </div>
      </div>
        
        <div id="track-preview"></div>

        <div class="weekly-tracks-wrapper">
          <h3 class="section-subtitle">Top tracks this week (click to play)</h3>
          <div id="weekly-tracks"></div>
        </div>
      </div>

    </div>

  </aside>
</div>


<script>
const CSV_URL =
  "https://raw.githubusercontent.com/marcolanfranchi/spotify-history/main/data/plays.csv";

/* ================= CSV ================= */
function parseCSVLine(line) {
  const result = [];
  let current = "";
  let inQuotes = false;
  for (let char of line) {
    if (char === '"') inQuotes = !inQuotes;
    else if (char === "," && !inQuotes) {
      result.push(current.trim());
      current = "";
    } else current += char;
  }
  result.push(current.trim());
  return result;
}

async function getPlays() {
  const res = await fetch(CSV_URL);
  const text = await res.text();
  const lines = text.trim().split("\n");

  return lines
    .slice(1)
    .map((line) => {
      const p = parseCSVLine(line);
      return {
        played_at: p[0],
        track_id: p[1],
        track_name: p[2] || "Unknown Track",
        artist_name: p[3] || "Unknown Artist",
      };
    })
    .filter((p) => p.played_at)
    .sort((a, b) => new Date(b.played_at) - new Date(a.played_at));
}

/* ================= UTIL ================= */
function getLocalDateKey(utc) {
  const d = new Date(utc);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}

function getLast7Days(plays) {
  const cutoff = Date.now() - 7 * 24 * 60 * 60 * 1000;
  return plays.filter(p => new Date(p.played_at).getTime() >= cutoff);
}

function formatDate(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString("en-US", {
    weekday: "short",
    month: "short",
    day: "numeric",
    year: "numeric"
  });
}

function generateDots(count) {
  const numDots = Math.min(count, 50);
  let dotsHtml = '';
  for (let i = 0; i < numDots; i++) {
    const randomDelay = Math.random() * 4.5;
    dotsHtml += `<span style="animation-delay: ${randomDelay.toFixed(2)}s">•</span>`;
  }
  return dotsHtml;
}

/* ================= QUICK STATS ================= */
function computeQuickStats(plays) {
  const firstPlay = plays[plays.length - 1];
  const firstDate = new Date(firstPlay.played_at);
  const formattedFirstDate = firstDate.toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric"
  });
  
  const dayGroups = plays.reduce((acc, p) => {
    const day = getLocalDateKey(p.played_at);
    acc[day] = (acc[day] || 0) + 1;
    return acc;
  }, {});
  
  const avgDaily = Math.round(plays.length / Object.keys(dayGroups).length);
  
  document.getElementById("first-day").textContent = formattedFirstDate;
  document.getElementById("total-plays-stat").textContent = plays.length.toLocaleString();
  document.getElementById("avg-daily").textContent = avgDaily;
}

/* ================= WEEKLY ================= */
function computeWeeklyStats(plays) {
  const week = getLast7Days(plays);

  const hours = ((week.length * 3.5) / 60).toFixed(1);

  const artistCounts = {};
  const trackCounts = {};

  week.forEach(p => {
    artistCounts[p.artist_name] = (artistCounts[p.artist_name] || 0) + 1;
    trackCounts[p.track_name + " - " + p.artist_name] = (trackCounts[p.track_name + " - " + p.artist_name] || 0) + 1;
  });

  const uniqueTracks = Object.keys(trackCounts).length;

  return {
    hours,
    topArtist: Object.entries(artistCounts).sort((a,b)=>b[1]-a[1])[0]?.[0] || "—",
    uniqueTracks: uniqueTracks,
  };
}

function renderWeeklyTracks(plays) {
  const week = getLast7Days(plays);
  const counts = {};

  week.forEach(p => {
    counts[p.track_id] = counts[p.track_id] || {...p, count:0};
    counts[p.track_id].count++;
  });

  const top = Object.values(counts)
    .sort((a,b)=>b.count - a.count)
    .slice(0,20);

  const list = document.getElementById("weekly-tracks");
  list.innerHTML = "";

  top.forEach((t, index) => {
    const div = document.createElement("div");
    div.className = "weekly-track";
    div.innerHTML = `
      <span class="track-number">${index + 1}</span>
      <span class="track-info">${t.track_name} <span class="track-artist">– ${t.artist_name}</span></span>
      <span class="track-count">${t.count}</span>
    `;
    div.onclick = () => {
      document.getElementById("track-preview").innerHTML = `
        <iframe
          src="https://open.spotify.com/embed/track/${t.track_id}"
          width="100%"
          height="80"
          frameborder="0"
          allow="encrypted-media">
        </iframe>`;
    };
    list.appendChild(div);
  });

  if (top.length > 0) {
    document.getElementById("track-preview").innerHTML = `
      <iframe
        src="https://open.spotify.com/embed/track/${top[0].track_id}"
        width="100%"
        height="80"
        frameborder="0"
        allow="encrypted-media">
      </iframe>`;
  }
}

/* ================= ACTIVITY CHART ================= */
function renderActivityChart(plays) {
  const chartContainer = document.getElementById("activity-chart");
  const monthsContainer = document.querySelector(".activity-months");
  chartContainer.innerHTML = "";
  monthsContainer.innerHTML = "";

  const playsByDay = plays.reduce((acc, play) => {
    const day = getLocalDateKey(play.played_at);
    acc[day] = (acc[day] || 0) + 1;
    return acc;
  }, {});

  const today = new Date();
  const startDate = new Date(today);
  startDate.setDate(today.getDate() - (30 * 7));

  const weeks = [];
  let currentWeek = [];
  let currentDate = new Date(startDate);

  const monthPositions = [];
  let lastMonth = -1;
  let weekIndex = 0;

  const startDay = currentDate.getDay();
  for (let i = 0; i < startDay; i++) {
    currentWeek.push(null);
  }

  while (currentDate <= today) {
    const dateKey = getLocalDateKey(currentDate.toISOString());
    const count = playsByDay[dateKey] || 0;
    
    const month = currentDate.getMonth();
    if (month !== lastMonth && currentDate.getDay() === 0) {
      monthPositions.push({
        month: currentDate.toLocaleDateString("en-US", { month: "short" }),
        position: weekIndex
      });
      lastMonth = month;
    }

    currentWeek.push({
      date: new Date(currentDate),
      dateKey: dateKey,
      count: count
    });

    if (currentWeek.length === 7) {
      weeks.push(currentWeek);
      currentWeek = [];
      weekIndex++;
    }

    currentDate.setDate(currentDate.getDate() + 1);
  }

  if (currentWeek.length > 0) {
    while (currentWeek.length < 7) {
      currentWeek.push(null);
    }
    weeks.push(currentWeek);
  }

  const cellWidth = 7;
  const gap = 2;
  const weekWidth = cellWidth + gap;

  monthPositions.forEach(({ month, position }) => {
    const label = document.createElement("span");
    label.className = "month-label";
    label.textContent = month;
    label.style.left = `${position * weekWidth}px`;
    monthsContainer.appendChild(label);
  });

  const maxCount = Math.max(...Object.values(playsByDay), 1);
  const getColor = (count) => {
    if (count === 0) return "#ebedf0";
    const intensity = count / maxCount;
    if (intensity < 0.25) return "#9be9a8";
    if (intensity < 0.5) return "#40c463";
    if (intensity < 0.75) return "#30a14e";
    return "#216e39";
  };

  const chart = document.createElement("div");
  chart.className = "activity-grid";

  const tooltip = document.createElement("div");
  tooltip.className = "activity-tooltip";
  document.body.appendChild(tooltip);

  weeks.forEach(week => {
    const weekCol = document.createElement("div");
    weekCol.className = "activity-week";
    
    week.forEach(day => {
      const dayCell = document.createElement("div");
      dayCell.className = "activity-day";
      
      if (day) {
        dayCell.style.backgroundColor = getColor(day.count);
        dayCell.dataset.date = day.date.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
        dayCell.dataset.count = day.count;

        dayCell.addEventListener("mouseenter", (e) => {
          tooltip.textContent = `${day.count} plays on ${dayCell.dataset.date}`;
          tooltip.style.display = "block";
          tooltip.style.left = `${e.pageX}px`;
          tooltip.style.top = `${e.pageY - 40}px`;
        });

        dayCell.addEventListener("mousemove", (e) => {
          tooltip.style.left = `${e.pageX}px`;
          tooltip.style.top = `${e.pageY - 40}px`;
        });

        dayCell.addEventListener("mouseleave", () => {
          tooltip.style.display = "none";
        });
      } else {
        dayCell.style.backgroundColor = "transparent";
      }
      
      weekCol.appendChild(dayCell);
    });
    
    chart.appendChild(weekCol);
  });

  chartContainer.appendChild(chart);
}

/* ================= MAIN ================= */
async function renderMusic() {
  const container = document.getElementById("music-container");
  container.innerHTML = "";

  const plays = await getPlays();
  document.getElementById("total-plays").textContent =
    `(${plays.length.toLocaleString()} plays logged in total)`;

  computeQuickStats(plays);

  const weekly = computeWeeklyStats(plays);
  document.getElementById("week-hours").textContent = weekly.hours;
  document.getElementById("week-top-artist").textContent = weekly.topArtist;
  document.getElementById("week-unique-tracks").textContent = weekly.uniqueTracks;

  renderWeeklyTracks(plays);
  renderActivityChart(plays);

  const byDay = plays.reduce((acc, play) => {
    const day = getLocalDateKey(play.played_at);
    acc[day] = acc[day] || [];
    acc[day].push(play);
    return acc;
  }, {});

  const days = Object.keys(byDay).sort((a, b) => new Date(b) - new Date(a));
  let lastMonth = null;

  days.forEach((day, index) => {
    const items = byDay[day];
    const dateObj = new Date(items[0].played_at);

    const monthLabel = dateObj.toLocaleDateString("en-US", {
      month: "long",
      year: "numeric"
    });

    if (monthLabel !== lastMonth) {
      lastMonth = monthLabel;

      const monthSeparator = document.createElement("div");
      monthSeparator.className = "music-month-separator";
      monthSeparator.textContent = monthLabel;
      container.appendChild(monthSeparator);
    }

    const isFirstDay = index === 0;

    const daySection = document.createElement("div");
    daySection.className = "music-day";

    const header = document.createElement("h3");
    header.className = "music-day-header";
    header.style.cursor = "pointer";
    header.innerHTML = `
      <span class="collapse-arrow">${isFirstDay ? '▼' : '▶'}</span>
      ${formatDate(items[0].played_at)}
      <span class="dot-bar">${generateDots(Math.min(items.length, 43))}</span>
      <span class="play-count">(${items.length})</span>
    `;

    const artistCounts = items.reduce((acc, play) => {
      acc[play.artist_name] = (acc[play.artist_name] || 0) + 1;
      return acc;
    }, {});

    const sortedArtists = Object.entries(artistCounts)
      .sort((a, b) => b[1] - a[1]);

    const artistList = document.createElement("div");
    artistList.className = "music-artists";
    artistList.style.display = isFirstDay ? "block" : "none";

    sortedArtists.forEach(([artist, count]) => {
      const artistItem = document.createElement("div");
      artistItem.className = "music-artist";
      artistItem.innerHTML = `
        <span class="artist-name">${artist}</span>
        <span class="artist-count">${count} play${count > 1 ? 's' : ''}</span>
      `;
      artistList.appendChild(artistItem);
    });

    header.addEventListener("click", () => {
      const isOpen = artistList.style.display === "block";
      artistList.style.display = isOpen ? "none" : "block";
      header.querySelector(".collapse-arrow").textContent = isOpen ? "▶" : "▼";
    });

    daySection.appendChild(header);
    daySection.appendChild(artistList);
    container.appendChild(daySection);
  });
}

renderMusic();
</script>

<style>
  /* ===== main two-column layout ===== */
.listening-layout {
  display: grid;
  grid-template-columns: 55% 45%;
  gap: 1rem;
  align-items: start;
}

/* left column */
.listening-left-column {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  min-width: 0;
}

/* right column */
.listening-sidebar {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

/* ===== sections ===== */
.section {
  padding: 0.5rem;
  margin-bottom: 0;
  border: 1px solid #000000;
  border-top-right-radius: 8px;
}

.section-title {
  font-size: 0.75rem;
  font-weight: 600;
  color: #111;
  margin-bottom: 0.5rem;
  letter-spacing: 0.5px;
}

.section-subtitle {
  font-size: 0.65rem;
  color: #666;
  margin: 0.25rem 0;
}

/* ===== quick stats ===== */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.5rem;
}

.stats-grid-left {
  grid-template-columns: repeat(3, 1fr);
}

.stats-grid-left .stat {
  text-align: left;
}

.stat {
  text-align: center;
  padding: 0.4rem 0;
}

.stat-value {
  font-size: 0.8rem;
  font-weight: 600;
  color: #111;
  margin-bottom: 0.1rem;
}

.stat-label {
  font-size: 0.65rem;
  color: #666;
}

/* ===== weekly ===== */
.weekly-grid {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.weekly-stats {
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
}

.weekly-tracks-wrapper {
  display: flex;
  flex-direction: column;
}

.weekly-track {
  font-size: 0.7rem;
  padding: 0.3rem 0.5rem;
  cursor: pointer;
  color: #333;
  display: flex;
  align-items: center;
  gap: 0.4rem;
  border-bottom: 1px solid #ddd;
  transition: background 0.1s;
}

.weekly-track:hover {
  background: #f0f0f0;
}

.section-weekly .stat {
  padding: 0.2rem 0;
}

.track-number {
  font-weight: 600;
  color: #999;
  min-width: 1rem;
  font-size: 0.65rem;
}

.track-info {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.track-artist {
  color: #666;
}

.track-count {
  font-size: 0.65rem;
  color: #666;
  border: 1px solid #ccc;
  padding: 0.1rem 0.3rem;
  font-weight: 500;
}

#track-preview {
  margin: 0.5rem;
  padding-top: 0.5rem;
  padding-bottom: 0.5rem;
  border-top: 0.5px solid #111;
  border-bottom: 0.5px solid #111;
}

/* ===== activity ===== */
.activity-chart-wrapper {
  overflow-x: auto;
  overflow-y: auto;
  margin-top: 0.5rem;
}

.activity-months {
  display: flex;
  position: relative;
  height: 16px;
  margin-bottom: 3px;
  margin-left: 26px;
}

.month-label {
  position: absolute;
  font-size: 0.65rem;
  color: #666;
}

.activity-content {
  display: flex;
  gap: 5px;
}

.activity-days-labels {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.activity-days-labels span {
  height: 7px;
  font-size: 0.6rem;
  color: #666;
  line-height: 7px;
  text-align: right;
  padding-right: 3px;
  width: 20px;
}

.activity-grid {
  display: flex;
  gap: 2px;
}

.activity-week {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.activity-day {
  width: 7px;
  height: 7px;
  border: 1px solid #ccc;
  cursor: pointer;
  transition: transform 0.1s;
}

.activity-day:hover {
  transform: scale(1.2);
}

.activity-tooltip {
  position: absolute;
  display: none;
  background-color: #fff;
  color: #000;
  border: 1px solid #000;
  padding: 4px 8px;
  font-size: 0.7rem;
  pointer-events: none;
  white-space: nowrap;
  z-index: 1000;
  transform: translateX(-50%);
}

.activity-legend-wrapper {
  margin: 0.5rem 0 0 26px;
}

.activity-legend {
  display: flex;
  align-items: center;
  justify-content: flex-start;
  gap: 3px;
  font-size: 0.65rem;
  color: #666;
}

.legend-box {
  width: 7px;
  height: 7px;
  border: 1px solid #ccc;
}

/* ===== full log ===== */
.music-total {
  margin-top: 0.3rem;
  font-size: 0.75rem;
  color: #444;
}

.music-month-separator {
  margin-top: 1.5rem;
  margin-bottom: 0.5rem;
  font-size: 0.85rem;
  font-weight: 600;
  color: #111111;
}

.dot-bar {
  margin-left: 6px;
  color: #000;
  font-size: 0.9rem;
}

.dot-bar span {
  display: inline-block;
  animation: dotGlitch 4.5s infinite;
  color: #101010;
  opacity: 0.9;
}

@keyframes dotGlitch {
  0% { opacity: 0.9; }
  2% { opacity: 0.6; }
  3% { opacity: 0.3; }
  3.5% { opacity: 0.5; }
  4% { opacity: 0.2; }
  4.5% { opacity: 0.6; }
  5.5% { opacity: 0.4; }
  6% { opacity: 0.7; }
  7% { opacity: 0.9; }
  100% { opacity: 0.9; }
}

.music-day {
  margin-bottom: 0.75rem;
}

.music-day-header {
  margin: 0.3rem 0;
  font-size: 0.75rem;
  color: #222;
  font-weight: 500;
}

.collapse-arrow {
  display: inline-block;
  width: 1em;
  font-size: 0.65rem;
  color: #666;
}

.play-count {
  color: #888;
  font-size: 0.8em;
  font-weight: 400;
  margin-left: 0.2rem;
}

.music-artists {
  margin-top: 0.3rem;
  display: flex;
  flex-direction: column;
  gap: 0.2rem;
}

.music-artist {
  font-size: 0.7rem;
  color: #555;
  line-height: 1;
  display: flex;
  align-items: center;
  padding: 0.2rem 0;
  border-bottom: 1px solid #e8e8e8;
  gap: 0.4rem;
}

.artist-name {
  font-weight: 500;
  color: #333;
}

.artist-count {
  color: #999;
  font-size: 0.65rem;
}

@media (max-width: 768px) {
  .listening-layout {
    grid-template-columns: 1fr;
  }

  .listening-sidebar {
    order: -1;
  }

  .music-artist {
    font-size: 0.7rem;
  }
  .artist-count {
    font-size: 0.65rem;
  }
  .section {
    padding: 0.5rem;
  }
}
</style>
{% endblock %}